//librerias y configuracion
const express = require("express");
const cors = require("cors");
const sqlite3 = require("sqlite3").verbose();

const app = express();
const PORT = process.env.PORT || 3000;

//Habilitar JSON y acceso desde cualquier origen
app.use(cors());
app.use(express.json());

//base de datos

const db = new sqlite3.Database("encuesta.db");

//tabla de participantes
db.run(`
  CREATE TABLE IF NOT EXISTS participantes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    correo TEXT UNIQUE NOT NULL,
    nombre TEXT,
    apellido TEXT,
    edad INTEGER,
    genero TEXT,
    sector TEXT,
    yaVoto INTEGER DEFAULT 0  -- 0=no ha votado, 1=ya vot贸
  )
`);

//tabla de cargos 
db.run(`
  CREATE TABLE IF NOT EXISTS cargos (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    nombre TEXT NOT NULL
  )
`);

//opciones para votar en cada cargo
db.run(`
  CREATE TABLE IF NOT EXISTS aspirantes (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    idCargo INTEGER NOT NULL,
    nombre TEXT NOT NULL
  )
`);

//tabla para guardamos los votos
db.run(`
  CREATE TABLE IF NOT EXISTS votos (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    idParticipante INTEGER NOT NULL,
    idCargo INTEGER NOT NULL,
    idAspirante INTEGER NOT NULL,
    fecha TEXT
  )
`);

//insertar datos iniciales de cargos y aspirantes
function crearDatosIniciales() {
  db.get("SELECT COUNT(*) AS total FROM cargos", (err, row) => {
    if (row.total > 0) return; //si ya existen no repetir

    const cargos = ["Presidente", "Vicepresidente", "Secretario(a)"];
    const opciones = ["Candidato 1", "Candidato 2", "Candidato 3", "Ninguno", "No se"];

    cargos.forEach(cargo => {
      db.run("INSERT INTO cargos(nombre) VALUES(?)", [cargo], function () {
        const idCargo = this.lastID;

        opciones.forEach(opcion => {
          db.run("INSERT INTO aspirantes(idCargo,nombre) VALUES(?,?)", [idCargo, opcion]);
        });
      });
    });
  });
}

crearDatosIniciales();

//registro y lista de participantes
//registrar participante
app.post("/api/participantes", (req, res) => {
  const { correo, nombre, apellido, edad, genero, sector } = req.body;

  if (!correo) return res.json({ error: "Correo obligatorio" });

  db.run(
    "INSERT INTO participantes(correo,nombre,apellido,edad,genero,sector) VALUES(?,?,?,?,?,?)",
    [correo, nombre, apellido, edad, genero, sector],
    function () {
      res.json({ id: this.lastID, correo });
    }
  );
});

//ver participantes 
app.get("/api/participantes", (req, res) => {
  db.all("SELECT * FROM participantes", (err, filas) => res.json(filas));
});

//validar voto por correo
app.get("/api/participantePorCorreo", (req, res) => {
  const correo = req.query.correo;

  db.get("SELECT * FROM participantes WHERE correo=?", [correo], (err, p) => {
    if (!p) return res.json({ permitido: false, motivo: "Correo no registrado" });
    if (p.yaVoto == 1) return res.json({ permitido: false, motivo: "Ya vot贸" });
    res.json({ permitido: true, participante: p });
  });
});

//mostrar cargos y aspirantes
app.get("/api/cargosConAspirantes", (req, res) => {
  db.all("SELECT * FROM cargos", (err, cargos) => {
    db.all("SELECT * FROM aspirantes", (err2, aspirantes) => {
      //combinar cargos con sus aspirantes
      const resultado = cargos.map(c => ({
        idCargo: c.id,
        nombre: c.nombre,
        aspirantes: aspirantes.filter(a => a.idCargo == c.id)
      }));
      res.json(resultado);
    });
  });
});

//registrar votos
app.post("/api/votar", (req, res) => {
  const { correo, votos } = req.body;

  //Verificar que exista el correo
  db.get("SELECT * FROM participantes WHERE correo=?", [correo], (err, p) => {
    if (!p) return res.json({ error: "Correo no registrado" });
    if (p.yaVoto == 1) return res.json({ error: "Ya vot贸" });

    const fecha = new Date().toISOString();

    votos.forEach(v => {
      db.run(
        "INSERT INTO votos(idParticipante,idCargo,idAspirante,fecha) VALUES(?,?,?,?)",
        [p.id, v.idCargo, v.idAspirante, fecha]
      );
    });

    //marcar que ya vot贸
    db.run("UPDATE participantes SET yaVoto=1 WHERE id=?", [p.id]);

    res.json({ ok: true, mensaje: "Voto registrado" });
  });
});

//resultados de la votacion
app.get("/api/resultados", (req, res) => {
  const sql = `
    SELECT c.nombre AS cargo, a.nombre AS aspirante, COUNT(v.id) AS votos
    FROM cargos c
    LEFT JOIN aspirantes a ON a.idCargo=c.id
    LEFT JOIN votos v ON v.idAspirante=a.id
    GROUP BY c.id, a.id
  `;
  db.all(sql, (err, filas) => res.json(filas));
});

//ruta raiz
app.get("/", (req, res) => {
  res.send("API de Encuesta funcionando...");
});

//Iniciar el servidor
app.listen(PORT, () =>
  console.log("Servidor en http://localhost:" + PORT)
);
